<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>Extremely soft blog launch!</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="A Pelican Blog Atom Feed" />
        <meta name="description" content="To test that my blog implementation works, I'll share my pytorchlightning-based replication of dataset cartography!" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">A Pelican Blog</a></h1>
                <nav><ul>
                    <li class="active"><a href="/category/about.html">About</a></li>
                    <li><a href="/category/acl-2021.html">ACL 2021</a></li>
                    <li><a href="/category/announcements.html">Announcements</a></li>
                    <li><a href="/category/career.html">Career</a></li>
                    <li><a href="/category/improving-ai-science.html">Improving AI Science</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/extremely-soft-blog-launch.html" rel="bookmark"
           title="Permalink to Extremely soft blog launch!">Extremely soft blog launch!</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2023-06-03T00:00:00+00:00">
                Published: Sat 03 June 2023
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/michael-saxon.html">Michael Saxon</a>
        </address>
<p>In <a href="/category/about.html">About</a>.</p>
<p>tags: <a href="/tag/about.html">About</a> </p>
</footer><!-- /.post-info -->      <h3>About my blog</h3>
<p>I have thoughts I'd like to share from time-to-time. I have been testing my Pelican-based blog generator for a while and got it working, but a lack of fully-formed blogpost ideas to upload has consequently kept me from updating my website for months. This has become a problem for me as news and results have accumulated. Thus at this point, I have no choice but to push a placeholder blogpost such as this. Looking forward to making a more substantial post soon ðŸ«¡</p>
<h3>Implemented in PL</h3>
<p>Check out this code! You can pass in any <code>Callback</code> object from pytorch lightning, to track the training process of a model in pytorch lightning. This automatically collects the training dynamics statistics and writes them to a given output csv file for future processing and analysis!</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CartographyCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_base</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_base</span> <span class="o">=</span> <span class="n">output_base</span>

    <span class="k">def</span> <span class="nf">init_buffers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">):</span>
        <span class="n">key_nums</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;train&quot;</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">train</span><span class="p">),</span>
            <span class="s2">&quot;val&quot;</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">valid</span><span class="p">),</span>
            <span class="s2">&quot;test&quot;</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">confidences</span> <span class="o">=</span> <span class="n">define_samplewise_metric</span><span class="p">(</span><span class="n">key_nums</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correctnesses</span> <span class="o">=</span> <span class="n">define_samplewise_metric</span><span class="p">(</span><span class="n">key_nums</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cartography_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_base</span><span class="si">}</span><span class="s2">/conf_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">.npy&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">confidences</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_base</span><span class="si">}</span><span class="s2">/corr_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">.npy&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">correctnesses</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">batch_end_accumulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;logits&#39;</span><span class="p">]</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">indices</span>
        <span class="n">batch_idces</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">confidences</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">batch_idces</span><span class="p">]</span> <span class="o">=</span> <span class="n">confidence_elementwise</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">logits</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correctnesses</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">batch_idces</span><span class="p">]</span> <span class="o">=</span> <span class="n">correct_elementwise</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">preds</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_end_accumulate</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_validation_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">dataloader_idx</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_end_accumulate</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_test_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">dataloader_idx</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_end_accumulate</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_train_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cartography_save</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_validation_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cartography_save</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_test_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cartography_save</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_train_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_buffers</span><span class="p">(</span><span class="n">trainer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_sanity_check_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_buffers</span><span class="p">(</span><span class="n">trainer</span><span class="p">)</span>
</code></pre></div>

<p>I wrote this code so that I could replicate the <a href="https://arxiv.org/abs/2009.10795">Dataset Cartography</a> features of confidence and correctness to analyze the effectiveness of my <a href="https://arxiv.org/abs/2112.09237">PECO</a> tool for analyzing datasets. You can see the code used in-context <a href="https://github.com/michaelsaxon/DatasetAnalysis">here!</a></p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>